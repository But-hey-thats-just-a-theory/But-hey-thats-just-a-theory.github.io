@inject GameState GameState
@inject NavigationManager UriHelper

<div style="position:relative">
    <h1>Welcome to Quepland</h1>
    <p>Quepland 2 is a semi-idle adventure game set in the world of Quepland. It is heavily inspired by the developer's childhood addiction to Runescape.</p>

    @if (GameState.InitCompleted)
    {
        <div>
            @if (hasSave)
            {
                <div>
                    <button class="btn btn-primary" @onclick="@(() => LoadGame("Normal"))">
                        Load Game (Normal)
                    </button>
                </div>
                <br />
            }
            @if (hasHardcore)
            {
                <div>
                    <button class="btn btn-primary" @onclick="@(() => LoadGame("Hardcore"))">
                        Load Game (Hardcore)
                    </button>
                </div>
                <br />
            }
            @if (hasUltimate)
            {
                <div>
                    <button class="btn btn-primary" @onclick="@(() => LoadGame("Ultimate"))">
                        Load Game (Ultimate)
                    </button>
                </div>
                <br />
            }
        </div>
        @if (GameState.CurrentGameMode == GameState.GameType.Hardcore && Player.Instance.JustDied)
        {
            <button class="btn btn-primary" onclick="@(new Action(() => ResetGame()))">Begin New Game</button>
        }
        else
        {
            @if (selectedMode == "Normal" && hasSave ||
             selectedMode == "Hardcore" && hasHardcore ||
             selectedMode == "Ultimate" && hasUltimate)
            {
                if (hasShownWarning == false)
                {
                    <button class="btn btn-primary" onclick="@(new Action(() => ShowWarning()))">Begin New Game</button>

                }
                else
                {
                    <button class="btn btn-primary" onclick="@(new Action(() => StartGame()))">Begin New Game</button>
                    <div style="color:red">Warning:Creating a new game will override your current save with this game type.(@selectedMode)</div>
                }
            }
            else
            {
                <button class="btn btn-primary" onclick="@(new Action(() => StartGame()))">Begin New Game</button>
            }
        }
    }
    else
    {
        <button class="btn btn-primary" disabled>Begin New Game</button>
    }

    <div>
        Note:For best results, Quepland needs to be played in a separate window. Most browsers will pause the game after a few minutes in a background tab.
    </div>
</div>
        <!--
            <br />
            <div style="margin-left:-10px;">
                <Quepland_2.Components.CustomDropdownComponent DropdownItems="@GetGameModes()" @bind-Value="@selectedMode" BoxText="Game Mode(Normal)"></Quepland_2.Components.CustomDropdownComponent>

            </div>
        }
        <div>
            @if (hasSave == false)
            {
                if (selectedMode == "Normal")
                {
                    <div>Normal mode is the normal way to play the game. It's highly recommended you start out playing in this game mode.</div>
                }
                else if (selectedMode == "Hardcore")
                {
                    <div>Hardcore mode gives the player a single life to live. If you die, the game will delete your save and bring you back to the start menu.</div>
                }
                else if (selectedMode == "Ultimate")
                {
                    <div>Ultimate mode is an extreme version of the game where the player is not allowed to use the bank.</div>
                }
            }
        </div>
        -->



@code {

    public string selectedMode = "Normal";
    bool hasSave = false;
    bool hasHardcore = false;
    bool hasUltimate = false;
    bool hasShownWarning = false;
    public List<string> GetGameModes()
    {
        List<string> modes = new List<string>();
        var values = Enum.GetValues(typeof(GameState.GameType));
        foreach (var v in values)
        {
            modes.Add(v.ToString());
        }
        return modes;
    }
    public void ResetGame()
    {
        Player.Instance.ResetStats();
        Player.Instance.Inventory.Clear();
        Player.Instance.GetEquippedItems().Clear();
        Bank.Instance.Inventory.Clear();
        foreach(Area a in AreaManager.Instance.Areas)
        {
            a.IsUnlocked = false;
        }
        foreach(Region r in AreaManager.Instance.Regions)
        {
            r.IsUnlocked = false;
        }
        SetGameMode();
        if (GameState.CurrentGameMode == GameState.GameType.Ultimate)
        {
            Player.Instance.Inventory.AddItem(ItemManager.Instance.GetItemByName("Stone Axe"));
        }
        AreaManager.Instance.GetAreaByName("Quepland Fields").Unlock();
        GameState.ShowStartMenu = false;
        UriHelper.NavigateTo("/World/QueplandFields");
    }
    public async Task LoadGame(string mode)
    {
        GameState.ShowStartMenu = false;
        await SaveManager.LoadSaveGame(mode);
    }
    public async Task ShowWarning()
    {
        if (await SaveManager.HasSaveFile(selectedMode))
        {
            hasShownWarning = true;
            GameState.UpdateState();
        }
    }
    public void StartGame()
    {
        SetGameMode();
        if(GameState.CurrentGameMode == GameState.GameType.Ultimate)
        {
            Player.Instance.Inventory.AddItem(ItemManager.Instance.GetItemByName("Stone Axe"));
        }
        GameState.ShowStartMenu = false;
        AreaManager.Instance.GetAreaByName("Quepland Fields").Unlock();
        GameState.GoTo("World/QueplandFields");
    }
    public void SetGameMode()
    {
        if(selectedMode == "Normal")
        {
            GameState.CurrentGameMode = GameState.GameType.Normal;
        }
        else if(selectedMode == "Hardcore")
        {
            GameState.CurrentGameMode = GameState.GameType.Hardcore;
        }
        else if(selectedMode == "Ultimate")
        {
            GameState.CurrentGameMode = GameState.GameType.Ultimate;
        }
    }
    public void TestAlch()
    {
        GameState.ShowStartMenu = false;
        GameState.Location = "MountQuepleAlchemicalHall";
        UriHelper.NavigateTo("/World/AlchemicalHall/WindHall/");
    }
    protected override async Task OnInitializedAsync()
    {
        hasSave = await SaveManager.HasSaveFile("Normal");
        hasHardcore = await SaveManager.HasSaveFile("Hardcore");
        hasUltimate = await SaveManager.HasSaveFile("Ultimate");
        GameState.StateChanged += OnGameStateChanged;

    }
    public void Dispose()
    {
        GameState.StateChanged -= OnGameStateChanged;
    }
    void OnGameStateChanged(object sender, EventArgs e) => StateHasChanged();
}
